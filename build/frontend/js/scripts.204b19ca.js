"use strict";var app=angular.module("boasopcoesMean",["ngRoute","ngResource","ngCookies","ngTouch","ngSanitize","ui.bootstrap"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){var isLoggedIn=["$q","$timeout","$http","$rootScope","$location",function($q,$timeout,$http,$rootScope,$location){var deferred=$q.defer();return $http.get("/signedin").success(function(user){"0"!==user?($rootScope.isSignedIn=!0,$rootScope.currentUser=user,$timeout(deferred.resolve,0)):($rootScope.isSignedIn=!1,$rootScope.currentUser={},$timeout(function(){deferred.reject()},0),$location.url("/"))}),deferred.promise}];$httpProvider.interceptors.push("InterceptorService"),$routeProvider.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/404",{templateUrl:"views/404.html",controller:"404Ctrl"}).when("/admin",{templateUrl:"views/admin.html",controller:"AdminCtrl",resolve:{loggedin:isLoggedIn}}).when("/validate",{templateUrl:"views/mail.html",controller:"ValidateCtrl"}).when("/unvalidate",{templateUrl:"views/mail.html",controller:"ValidateCtrl"}).otherwise({redirectTo:"/404"}),$locationProvider.html5Mode(!0)}]),angular.module("boasopcoesMean").factory("InterceptorService",["$q","$location",function($q,$location){var ajaxInterceptor={response:function(response){return response||$q.when(response)},responseError:function(response){return 401===response.status&&$location.path("/"),$q.reject(response)}};return ajaxInterceptor}]),angular.module("boasopcoesMean").controller("MainCtrl",["$rootScope",function($rootScope){$rootScope.pageTitle="Homepage"}]),angular.module("boasopcoesMean").controller("AdminCtrl",["$rootScope","$scope","$http","$window",function($rootScope,$scope,$http,$window){$rootScope.pageTitle="Admin | "+$rootScope.currentUser.fullname,$scope.errorMessage="",$scope.tasks=[];var read=function(){$http.get("/task").success(function(tasks){"0"===tasks?($scope.tasks=[],$scope.errorMessage="There's no tasks in the database. Create one if you want !"):($scope.tasks=tasks,$scope.errorMessage="")}).error(function(error,status){$scope.errorMessage=error+" (code:"+status+")"})};$scope.create=function(){var prompt=$window.prompt("Create a new task :","Task Name");null!==prompt&&$http.post("/task",{name:prompt}).success(function(){read()}).error(function(error,status){$scope.errorMessage=error+" (code:"+status+")"})},$scope.edit=function(taskId,taskName){var prompt=$window.prompt("New task name :",taskName);null!==prompt&&$http.put("/task/"+taskId,{name:prompt}).success(function(){read()}).error(function(error,status){$scope.errorMessage=error+" (code:"+status+")"})},$scope["delete"]=function(taskId){$http["delete"]("/task/"+taskId).success(function(){read()}).error(function(error,status){$scope.errorMessage=error+" (code:"+status+")"})},read()}]),angular.module("boasopcoesMean").controller("HeaderCtrl",["$scope","$modal","$http","$window","$cookieStore",function($scope,$modal,$http,$window,$cookieStore){var isRemembered=["$q","$cookies","$http","$timeout","$location","$cookieStore",function($q,$cookies,$http,$timeout,$location,$cookieStore){var deferred=$q.defer();return $cookies.remember?$http.post("/signin").success(function(){$timeout(function(){deferred.reject()},0),$location.url("/admin")}).error(function(err,status){err&&401===status&&$cookieStore.remove("remember"),$timeout(deferred.resolve,0)}):$timeout(deferred.resolve,0),deferred.promise}];$scope.signinModal=function(){$modal.open({templateUrl:"signin.html",controller:"SigninCtrl",size:"sm",resolve:{remembered:isRemembered}})},$scope.signupModal=function(){$modal.open({templateUrl:"signup.html",controller:"SignupCtrl",size:"sm"})},$scope.signout=function(){$http.post("/signout").success(function(){$cookieStore.remove("remember"),$window.location.href="/"})}}]),angular.module("boasopcoesMean").controller("SigninCtrl",["$scope","$modalInstance","$window","$http",function($scope,$modalInstance,$window,$http){$scope.user={},$scope.signInMessage="",$scope.signin=function(){$http.post("/signin",$scope.user).success(function(){$window.location.href="/admin"}).error(function(data,tentatives){$scope.signInMessage="Wrong credentials, try again ( "+tentatives+" tentative(s) )"})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("boasopcoesMean").controller("SignupCtrl",["$scope","$modalInstance","$http","$window",function($scope,$modalInstance,$http,$window){$scope.user={},$scope.signUpMessage="",$scope.signup=function(){$http.post("/signup",$scope.user).success(function(){$window.location.href="/admin"}).error(function(data){$scope.signUpMessage=data})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("boasopcoesMean").controller("ValidateCtrl",["$scope","$http","$routeParams","$location",function($scope,$http,$routeParams,$location){$scope.title="Validate Email Address",$scope.message="Please wait...",$routeParams.email&&$routeParams.key&&$http.post("/unvalidate",{email:$routeParams.email,key:$routeParams.key}).success(function(){$scope.message="Your email has been deleted from our database.<br>We hope you will come back soon :)"}).error(function(data,status){403===status&&($scope.message="This email address has already been activated. You can't unvalidate it now."),404===status&&($scope.message="You sent a bad link, please try again.")}),$routeParams.key?$http.post("/validate",{key:$routeParams.key}).success(function(){$scope.message="Your account is actived. Please sign in now."}).error(function(data,status){404===status&&($scope.message="You sent a bad link, please try again to sign up."),403===status&&($scope.message="This email address is already actived.")}):$location.url("/")}]),angular.module("boasopcoesMean").controller("404Ctrl",["$rootScope","$scope",function($rootScope,$scope){$rootScope.pageTitle="404 Error",$scope.errorMessage="Sorry, but the requested page doesn't exist !"}]);